<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devs Coins ü™ô</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    >
    <style>
        * {margin:0;padding:0;box-sizing:border-box;}
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        .subtitle {
            color: rgba(255,255,255,0.9);
            text-align: center;
            margin-bottom: 25px;
        }
        .batata-quente-button {
            display:block;
            margin:0 auto 25px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color:white;
            border:none;
            border-radius:40px;
            padding:12px 25px;
            font-size:1.1em;
            font-weight:bold;
            cursor:pointer;
            transition:.3s;
        }
        .batata-quente-button:hover {transform:translateY(-2px);}

        .devs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        .dev-card {
            background:white;
            border-radius:12px;
            padding:20px;
            box-shadow:0 6px 20px rgba(0,0,0,.2);
            text-align:center;
            transition:.3s;
        }
        .dev-card:hover {transform:translateY(-4px);}
        .dev-name {font-size:1.4em;font-weight:bold;color:#333;}
        .coins {font-size:2em;color:#667eea;margin:10px 0;}
        .batata {font-size:1.6em;margin-bottom:8px;}
        .btn {cursor:pointer;border:none;border-radius:8px;padding:8px 14px;font-weight:bold;}
        .btn-batata {
            background:linear-gradient(135deg,#ff6b6b,#ff8e53);
            color:white;width:100%;margin-top:10px;
        }
        .btn-pay {
            background:#28a745;color:white;width:100%;margin-top:10px;
        }
        .btn-delete {background:#ff6b6b;color:white;margin-top:10px;}
        .floating-btn {
            position:fixed;
            bottom:25px;right:25px;
            background:#667eea;
            color:white;
            border:none;
            border-radius:50%;
            width:60px;height:60px;
            font-size:30px;
            cursor:pointer;
            box-shadow:0 6px 20px rgba(0,0,0,.3);
            transition:.3s;
        }
        .floating-btn:hover {transform:rotate(90deg);}
        .modal {
            display:none;
            position:fixed;
            top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,0.5);
            justify-content:center;align-items:center;
        }
        .modal-content {
            background:white;padding:25px;border-radius:10px;
            width:90%;max-width:400px;text-align:center;
        }
        input {
            width:100%;
            padding:10px;
            border:2px solid #ddd;
            border-radius:8px;
            margin-bottom:10px;
            font-size:1em;
        }
        .btn-primary {
            background:#667eea;color:white;width:100%;
            padding:10px;font-size:1em;
        }
        .success,.error {
            text-align:center;
            color:white;
            padding:10px;border-radius:6px;
            margin:15px auto;width:fit-content;
        }
        .success{background:#28a745;}
        .error{background:#ff6b6b;}
    </style>
</head>
<body>

<h1>üí∞ Devs Coins</h1>
<p class="subtitle">Pague e recebaü™ô entre devs</p>

<button class="batata-quente-button" onclick="verificarBatataQuente()">ü•î Quem est√° com a batata quente?</button>

<div id="message"></div>
<div id="batataQuenteResult"></div>
<div id="devsContainer"><div style="color:white;text-align:center;">Carregando devs...</div></div>

<!-- Bot√£o flutuante -->
<button class="floating-btn" onclick="abrirModal()">Ôºã</button>
<!-- Modal adicionar dev -->
<div id="modalAddDev" class="modal">
    <div class="modal-content">
        <h2>Adicionar Dev</h2>
        <input type="text" id="newDevName" placeholder="Nome do dev">
        <input type="number" id="newDevCoins" placeholder="Moedas iniciais" value="5" min="0">
        <button class="btn-primary" onclick="adicionarDev()">Salvar</button>
        <button class="btn" style="margin-top:10px" onclick="fecharModal()">Cancelar</button>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_URL = '/api/devs';
    let devs = [];

    function mostrarErro(mensagemTexto) {
        exibirMensagem(`<div class="error">${mensagemTexto}</div>`);
    }

    function mostrarSucesso(mensagemTexto) {
        exibirMensagem(`<div class="success">${mensagemTexto}</div>`);
    }

    function exibirMensagem(htmlMensagem) {
        const elementoMensagem = document.getElementById('message');
        elementoMensagem.innerHTML = htmlMensagem;
        setTimeout(() => elementoMensagem.innerHTML = '', 3000);
    }

    carregarDevs();

    async function carregarDevs() {
        try {
            const resposta = await fetch(API_URL);
            if (!resposta.ok) throw new Error();
            devs = await resposta.json();
            renderizarDevs(devs);
        } catch (erro) {
            mostrarErro('Erro ao conectar com o servidor.');
        }
    }

    function renderizarDevs(listaDevs) {
    debugger;
        const container = document.getElementById('devsContainer');
        if (!listaDevs.length) {
            container.innerHTML = `<div style="text-align:center;color:white;">Nenhum dev cadastrado üßë‚Äçüíª</div>`;
            return;
        }
        listaDevs.sort((a, b) => a.id - b.id);

        container.innerHTML = `
            <div class="devs-grid">
                ${listaDevs.map(dev =>
                    `<div class="dev-card">
                        <div class="dev-name">${dev.nome}</div>
                        <div class="coins">ü™ô ${dev.moedas}</div>
                        <div class="batata">ü•î ${dev.batataQuente}</div>
                        <button class="btn btn-batata" onclick="incrementarBatata(${dev.id})">+1 Batata</button>
                        <button class="btn btn-pay" onclick="abrirPagamento(${dev.id})">üí∞ Pagar</button>
                        <button class="btn btn-delete" onclick="deletarDev(${dev.id})">üóëÔ∏è</button>
                    </div>`
                ).join('')}
            </div>`;
    }

    async function adicionarDev() {
        const nome = document.getElementById('newDevName').value.trim();
        const moedas = parseInt(document.getElementById('newDevCoins').value) || 0;

        if (!nome) {
            return mostrarErro('Digite o nome do dev');
        }

        try {
            const resposta = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nome, moedas })
            });

            if (!resposta.ok) throw new Error();

            mostrarSucesso('Dev adicionado com sucesso!');
            fecharModal();
            carregarDevs();
        } catch (erro) {
            mostrarErro('Erro ao adicionar dev');
        }
    }

    function abrirModal() {
        document.getElementById('modalAddDev').style.display = 'flex';
    }

    function fecharModal() {
        document.getElementById('modalAddDev').style.display = 'none';
    }

    async function incrementarBatata(devId) {
        try {
            const resposta = await fetch(`${API_URL}/${devId}/batata-quente`, { method: 'POST' });
            if (!resposta.ok) throw new Error();
            mostrarSucesso('Batata +1!');
            carregarDevs();
        } catch (erro) {
            mostrarErro('Erro ao incrementar batata');
        }
    }

    async function verificarBatataQuente() {
        try {
            const resposta = await fetch(`${API_URL}/batata-quente/menor`);
            if (!resposta.ok) throw new Error();

            const devComMenosBatatas = await resposta.json();

            document.getElementById('batataQuenteResult').innerHTML = `
                <div class="success">ü•î ${devComMenosBatatas.nome} est√° com a batata quente (${devComMenosBatatas.batataQuente})</div>
            `;

            setTimeout(() => document.getElementById('batataQuenteResult').innerHTML = '', 4000);
        } catch (erro) {
            mostrarErro('Erro ao verificar quem est√° com a batata quente');
        }
    }

    async function deletarDev(devId) {
        const devEncontrado = devs.find(dev => dev.id === devId);
        if (!confirm(`Deletar ${devEncontrado.nome}?`)) return;

        try {
            const resposta = await fetch(`${API_URL}/${devId}`, { method: 'DELETE' });
            if (!resposta.ok) throw new Error();

            mostrarSucesso(`${devEncontrado.nome} removido com sucesso`);
            carregarDevs();
        } catch (erro) {
            mostrarErro('Erro ao deletar dev');
        }
    }

    function abrirPagamento(devIdRecebedor) {
        const devRecebedor = devs.find(dev => dev.id === devIdRecebedor);
        if (!devRecebedor) return;

        removerModalPagamentoExistente();
        criarModalPagamento(devRecebedor);
        inicializarModalPagamento(devRecebedor);
    }

    function removerModalPagamentoExistente() {
        const modalAntigo = document.getElementById('modalPagamento');
        if (modalAntigo) modalAntigo.remove();
    }

    function criarModalPagamento(devRecebedor) {
        const opcoesDevsPagadores = devs
            .filter(dev => dev.id !== devRecebedor.id)
            .map(dev => `<option value="${dev.id}">${dev.nome} (${dev.moedas} ü™ô)</option>`)
            .join('');

        const conteudoModal = `
            <div class="modal fade" id="modalPagamento" tabindex="-1" aria-labelledby="modalPagamentoLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content rounded-4 shadow">
                  <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="modalPagamentoLabel">üí∞ Pagamento para ${devRecebedor.nome}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                  </div>
                  <div class="modal-body">
                    <label class="form-label">Selecione quem vai pagar</label>
                    <select id="seletorDevPagador" class="form-select">
                        <option value="">-- Escolha o dev pagador --</option>
                        ${opcoesDevsPagadores}
                    </select>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" id="botaoConfirmarPagamento">Confirmar Pagamento</button>
                  </div>
                </div>
              </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', conteudoModal);
    }

    function inicializarModalPagamento(devRecebedor) {
        const elementoModal = document.getElementById('modalPagamento');
        const modalBootstrap = new bootstrap.Modal(elementoModal);
        modalBootstrap.show();

        document.getElementById('botaoConfirmarPagamento').addEventListener('click', () => {
            confirmarPagamentoEntreDevs(modalBootstrap, devRecebedor);
        });
    }

    async function confirmarPagamentoEntreDevs(modalBootstrap, devRecebedor) {
        const identificadorDevPagador = parseInt(document.getElementById('seletorDevPagador').value);

        if (!identificadorDevPagador) {
            alert('Selecione quem vai pagar!');
            return;
        }

        const devPagador = devs.find(dev => dev.id === identificadorDevPagador);
        if (!devPagador) return;

        try {
            const resposta = await fetch(`${API_URL}/transferir`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    devPagadorId: devPagador.id,
                    devRecebedorId: devRecebedor.id
                })
            });

            if (!resposta.ok) throw new Error();

            mostrarSucesso(`${devPagador.nome} pagou 1 moeda para ${devRecebedor.nome}!`);
            modalBootstrap.hide();
            carregarDevs();
        } catch (erro) {
            mostrarErro('Erro ao realizar o pagamento da moeda.');
        }
    }
</script>

</body>
</html>

